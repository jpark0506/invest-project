AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: invest-assist API

Globals:
  Function:
    Runtime: nodejs20.x
    Timeout: 30
    MemorySize: 256
    Architectures:
      - arm64
    Environment:
      Variables:
        NODE_ENV: !Ref Environment
        DYNAMODB_USERS_TABLE: !Ref UsersTable
        DYNAMODB_PORTFOLIOS_TABLE: !Ref PortfoliosTable
        DYNAMODB_PLANS_TABLE: !Ref PlansTable
        DYNAMODB_EXECUTIONS_TABLE: !Ref ExecutionsTable
        DYNAMODB_AUTH_TOKENS_TABLE: !Ref AuthTokensTable
        DYNAMODB_REFRESH_TOKENS_TABLE: !Ref RefreshTokensTable
        DYNAMODB_NOTIFICATION_LOGS_TABLE: !Ref NotificationLogsTable
        JWT_SECRET_ARN: !Ref JwtSecretArn
        SES_FROM_EMAIL: !Ref SesFromEmail
        APP_URL: !Ref AppUrl
        API_URL: !Ref ApiUrl
        KAKAO_CLIENT_ID: !Ref KakaoClientId
        KAKAO_CLIENT_SECRET: !Ref KakaoClientSecret

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
  JwtSecretArn:
    Type: String
    Description: ARN of the JWT secret in Secrets Manager
  SesFromEmail:
    Type: String
    Description: Verified SES email address for sending notifications
  AppUrl:
    Type: String
    Description: Frontend application URL
    Default: http://localhost:5173
  ApiUrl:
    Type: String
    Description: Backend API URL
    Default: http://localhost:3000
  KakaoClientId:
    Type: String
    Description: Kakao OAuth Client ID
    Default: ''
  KakaoClientSecret:
    Type: String
    Description: Kakao OAuth Client Secret
    NoEcho: true
    Default: ''

Resources:
  # ========== Shared Lambda Role ==========
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub invest-assist-lambda-role-${Environment}
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt UsersTable.Arn
                  - !Sub ${UsersTable.Arn}/index/*
                  - !GetAtt PortfoliosTable.Arn
                  - !GetAtt PlansTable.Arn
                  - !GetAtt ExecutionsTable.Arn
                  - !GetAtt AuthTokensTable.Arn
                  - !GetAtt RefreshTokensTable.Arn
                  - !Sub ${RefreshTokensTable.Arn}/index/*
                  - !GetAtt NotificationLogsTable.Arn
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref JwtSecretArn
        - PolicyName: SESAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ses:SendEmail
                  - ses:SendRawEmail
                Resource: '*'

  # ========== API Gateway ==========
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Environment
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,Origin'"
        AllowOrigin: "'https://invest-project-orpin.vercel.app'"
        AllowCredentials: true
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'https://invest-project-orpin.vercel.app'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,Origin'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
              Access-Control-Allow-Credentials: "'true'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'https://invest-project-orpin.vercel.app'"
              Access-Control-Allow-Headers: "'Content-Type,Authorization,Origin'"
              Access-Control-Allow-Methods: "'GET,POST,PUT,DELETE,OPTIONS'"
              Access-Control-Allow-Credentials: "'true'"

  # ========== Auth Functions ==========
  AuthStartFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: start.handler
      CodeUri: src/modules/auth/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/start
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - start.ts
        External:
          - '@aws-sdk/*'

  AuthVerifyFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: verify.handler
      CodeUri: src/modules/auth/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/verify
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - verify.ts
        External:
          - '@aws-sdk/*'

  AuthRefreshFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: refresh.handler
      CodeUri: src/modules/auth/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/refresh
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - refresh.ts
        External:
          - '@aws-sdk/*'

  AuthLogoutFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: logout.handler
      CodeUri: src/modules/auth/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/logout
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - logout.ts
        External:
          - '@aws-sdk/*'

  AuthKakaoFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: kakao.handler
      CodeUri: src/modules/auth/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/kakao
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - kakao.ts
        External:
          - '@aws-sdk/*'

  AuthKakaoCallbackFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: kakaoCallback.handler
      CodeUri: src/modules/auth/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/kakao/callback
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - kakaoCallback.ts
        External:
          - '@aws-sdk/*'

  # ========== User Functions ==========
  MeFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: me.handler
      CodeUri: src/modules/user/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /me
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - me.ts
        External:
          - '@aws-sdk/*'

  CompleteOnboardingFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: completeOnboarding.handler
      CodeUri: src/modules/user/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /onboarding/complete
            Method: PUT
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - completeOnboarding.ts
        External:
          - '@aws-sdk/*'

  DeleteAccountFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: deleteAccount.handler
      CodeUri: src/modules/user/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /account
            Method: DELETE
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - deleteAccount.ts
        External:
          - '@aws-sdk/*'

  # ========== Portfolio Functions ==========
  GetPortfolioFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: get.handler
      CodeUri: src/modules/portfolio/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /portfolio
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get.ts
        External:
          - '@aws-sdk/*'

  PutPortfolioFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: put.handler
      CodeUri: src/modules/portfolio/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /portfolio
            Method: PUT
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - put.ts
        External:
          - '@aws-sdk/*'

  # ========== Plan Functions ==========
  GetPlanFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: get.handler
      CodeUri: src/modules/plan/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /plan
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - get.ts
        External:
          - '@aws-sdk/*'

  PutPlanFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: put.handler
      CodeUri: src/modules/plan/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /plan
            Method: PUT
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - put.ts
        External:
          - '@aws-sdk/*'

  # ========== Execution Functions ==========
  GetExecutionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: list.handler
      CodeUri: src/modules/execution/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /executions
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - list.ts
        External:
          - '@aws-sdk/*'

  GetExecutionDetailFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: detail.handler
      CodeUri: src/modules/execution/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /executions/{ymCycle}
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - detail.ts
        External:
          - '@aws-sdk/*'

  ConfirmExecutionFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: confirm.handler
      CodeUri: src/modules/execution/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /executions/{ymCycle}/confirm
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - confirm.ts
        External:
          - '@aws-sdk/*'

  # ========== Scheduler Function ==========
  SchedulerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: run.handler
      CodeUri: src/modules/scheduler/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      MemorySize: 512
      Events:
        ScheduleRule:
          Type: Schedule
          Properties:
            Schedule: cron(0 0 * * ? *)
            Description: Daily scheduler for execution generation
            Enabled: true
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - run.ts
        External:
          - '@aws-sdk/*'

  SchedulerTriggerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: trigger.handler
      CodeUri: src/modules/scheduler/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /scheduler/trigger
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - trigger.ts
        External:
          - '@aws-sdk/*'

  # ========== Ticker Functions ==========
  TickerSearchFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: search.handler
      CodeUri: src/modules/ticker/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 10
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /tickers/search
            Method: GET
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - search.ts
        External:
          - '@aws-sdk/*'

  TickerValidateFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: validate.handler
      CodeUri: src/modules/ticker/handlers/
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 5
      Events:
        Api:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /tickers/validate
            Method: POST
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Target: es2022
        Sourcemap: false
        EntryPoints:
          - validate.ts
        External:
          - '@aws-sdk/*'

  # ========== DynamoDB Tables ==========
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub invest-assist-users-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: emailIndex
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  PortfoliosTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub invest-assist-portfolios-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: portfolioId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: portfolioId
          KeyType: RANGE

  PlansTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub invest-assist-plans-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: planId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: planId
          KeyType: RANGE

  ExecutionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub invest-assist-executions-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: ymCycle
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: ymCycle
          KeyType: RANGE

  AuthTokensTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub invest-assist-auth-tokens-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tokenHash
          AttributeType: S
      KeySchema:
        - AttributeName: tokenHash
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

  RefreshTokensTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub invest-assist-refresh-tokens-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tokenId
          AttributeType: S
        - AttributeName: tokenHash
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: tokenId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: tokenHashIndex
          KeySchema:
            - AttributeName: tokenHash
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: userIdIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

  NotificationLogsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub invest-assist-notification-logs-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: sentAtType
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: sentAtType
          KeyType: RANGE

Outputs:
  ApiUrl:
    Description: API Gateway endpoint URL
    Value: !Sub https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/${Environment}
